<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Test Set9</title>
<style>
html,body {margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:black;}
canvas {position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;}
#startButton {position:fixed; top:0; left:0; width:100%; height:100%; background:transparent; border:none; cursor:pointer; z-index:10;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<audio id="audio" loop></audio>
<button id="startButton"></button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- Set9 images et audio ---
const set9Images = [
    "images/set9trans1.jpg",
    "images/set9trans2.jpg",
    "images/set9trans3.jpg",
    "images/set9trans4.jpg",
    "images/set9final.jpg"
];
const specialImgPath = "images/set9special.jpg";
const audioSrc = "audio/audio9.mp3";

let loadedImgs = [];
const tempCanvas = document.createElement('canvas');
const tctx = tempCanvas.getContext('2d');
tempCanvas.width = canvas.width;
tempCanvas.height = canvas.height;

// --- Audio ---
const audioElement = document.getElementById('audio');
audioElement.src = audioSrc;
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
source.connect(audioCtx.destination);

// --- Clicks ---
let clickCount = 0;
const maxClicks = 46;
let specialVisible = false;
let ratio = 0;

// --- Préload images ---
async function preloadImages(paths){
    const promises = paths.map(p => new Promise(resolve=>{
        const img = new Image();
        img.src = p;
        img.onload = ()=>resolve(img);
        img.onerror = ()=>resolve(img);
    }));
    loadedImgs = await Promise.all(promises);

    // Test : dessine la première image pour vérifier
    ctx.drawImage(loadedImgs[0],0,0,canvas.width,canvas.height);
}
preloadImages(set9Images);

// --- Start button ---
document.getElementById('startButton').addEventListener('click',()=>{
    audioCtx.resume();
    audioElement.play();
    document.getElementById('startButton').style.display='none';
});

// --- Morphing ---
const steps = [10,20,30,40,maxClicks];
function getTransitionIndex(click){
    for(let i=0;i<steps.length;i++){
        if(click<=steps[i]){
            const prevIndex = i===0?0:i-1;
            const alpha = (click-(i===0?0:steps[i-1]))/(steps[i]-(i===0?0:steps[i-1]));
            return {prevIndex,nextIndex:i,alpha};
        }
    }
    return {prevIndex:loadedImgs.length-2,nextIndex:loadedImgs.length-1,alpha:1};
}

function morphImages(img1,img2,alpha){
    tctx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
    tctx.globalAlpha = 1-alpha;
    tctx.drawImage(img1,0,0,tempCanvas.width,tempCanvas.height);
    tctx.globalAlpha = alpha;
    tctx.drawImage(img2,0,0,tempCanvas.width,tempCanvas.height);
    tctx.globalAlpha = 1;
    ctx.drawImage(tempCanvas,0,0,canvas.width,canvas.height);
}

// --- Draw loop ---
function draw(){
    function frame(){
        requestAnimationFrame(frame);

        if(specialVisible) return; // image spéciale visible, pas d'effets

        const {prevIndex,nextIndex,alpha} = getTransitionIndex(clickCount);
        morphImages(loadedImgs[prevIndex], loadedImgs[nextIndex], alpha);

        // --- Glitch ---
        const w = canvas.width, h = canvas.height;
        const blockCount = Math.floor(ratio*200);
        for(let i=0;i<blockCount;i++){
            const bx = Math.floor(Math.random()*w);
            const by = Math.floor(Math.random()*h);
            const bw = Math.floor(Math.random()*30+5);
            const bh = Math.floor(Math.random()*30+5);
            const tempData = ctx.getImageData(bx,by,bw,bh);
            const dx = Math.floor((Math.random()-0.5)*150*ratio);
            const dy = Math.floor((Math.random()-0.5)*150*ratio);
            ctx.putImageData(tempData,bx+dx,by+dy);
        }

        // --- CSS filtre ---
        const contrast = 1 + ratio*5;
        const saturate = 1 + ratio*5;
        const hue = ratio*360;
        document.body.style.filter = `contrast(${contrast}) saturate(${saturate}) hue-rotate(${hue}deg)`;
    }
    frame();
}
draw();

// --- Click handler ---
document.body.addEventListener('click',()=>{
    if(specialVisible) return;
    clickCount++;
    if(clickCount>maxClicks) clickCount=maxClicks;
    ratio = clickCount/maxClicks;

    if(clickCount===maxClicks){
        // Affiche l'image spéciale, stop audio et effets
        const img = new Image();
        img.src = specialImgPath;
        img.onload = ()=>{
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
        };
        audioElement.pause();
        audioCtx.suspend();
        specialVisible = true;
    }
});
</script>
</body>
</html>

