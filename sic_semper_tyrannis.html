<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Set9 Test</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:black; }
canvas { position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0; }
#set9special { position:fixed; top:0; left:0; width:100%; height:100%; display:none; z-index:100; cursor:pointer; }
#startButton { position:fixed; top:0; left:0; width:100%; height:100%; background:transparent; border:none; cursor:pointer; z-index:10; }
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<img id="set9special" src="images/set9special.jpg">
<button id="startButton"></button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Set9 transitions
const transitions = [
  "images/set9trans1.jpg",
  "images/set9trans2.jpg",
  "images/set9trans3.jpg",
  "images/set9trans4.jpg",
  "images/set9final.jpg"
];

// Audio
const audioElement = new Audio("audio/audio9.mp3");
audioElement.loop = true;

// Preload images
let loadedImages = [];
async function preloadImages(sources) {
  const promises = sources.map(src => new Promise(resolve => {
    const img = new Image();
    img.src = src;
    img.onload = () => resolve(img);
    img.onerror = () => resolve(null);
  }));
  loadedImages = await Promise.all(promises);
}

// Start button
document.getElementById('startButton').addEventListener('click',()=>{
  audioElement.play();
  document.getElementById('startButton').style.display='none';
});

let clickCount=0;
const maxClicks = 46;
let ratio = 0;
let specialVisible = false;

// Morphing helper
const tempCanvas = document.createElement('canvas');
tempCanvas.width = canvas.width;
tempCanvas.height = canvas.height;
const tctx = tempCanvas.getContext('2d');

function getTransitionIndex(click){
  const steps = [10,20,30,40,46];
  for(let i=0;i<steps.length;i++){
    if(click <= steps[i]){
      const prev = i===0?0:i-1;
      const alpha = (click - (i===0?0:steps[i-1])) / (steps[i]-(i===0?0:steps[i-1]));
      return {prev, next:i, alpha};
    }
  }
  return {prev:transitions.length-2, next:transitions.length-1, alpha:1};
}

function morphImages(img1,img2,alpha){
  tctx.clearRect(0,0,tempCanvas.width,tempCanvas.height);
  tctx.globalAlpha = 1-alpha;
  tctx.drawImage(img1,0,0,tempCanvas.width,tempCanvas.height);
  tctx.globalAlpha = alpha;
  tctx.drawImage(img2,0,0,tempCanvas.width,tempCanvas.height);
  tctx.globalAlpha = 1;
  ctx.drawImage(tempCanvas,0,0,canvas.width,canvas.height);
}

// Draw loop
async function drawLoop(){
  await preloadImages(transitions);
  function frame(){
    requestAnimationFrame(frame);

    if(specialVisible) return; // stop draw on special

    const {prev,next,alpha} = getTransitionIndex(clickCount);
    morphImages(loadedImages[prev], loadedImages[next], alpha);

    // glitch effect
    const w = canvas.width, h = canvas.height;
    const blockCount = Math.floor(ratio*200);
    for(let i=0;i<blockCount;i++){
      const bx=Math.floor(Math.random()*w);
      const by=Math.floor(Math.random()*h);
      const bw=Math.floor(Math.random()*30+5);
      const bh=Math.floor(Math.random()*30+5);
      const tempData = ctx.getImageData(bx,by,bw,bh);
      const dx = Math.floor((Math.random()-0.5)*150*ratio);
      const dy = Math.floor((Math.random()-0.5)*150*ratio);
      ctx.putImageData(tempData,bx+dx,by+dy);
    }

    // CSS filters
    const contrast = 1+ratio*5;
    const saturate = 1+ratio*5;
    const hue = ratio*360;
    document.body.style.filter = `contrast(${contrast}) saturate(${saturate}) hue-rotate(${hue}deg)`;
  }
  frame();
}
drawLoop();

// Click handling
document.body.addEventListener('click',()=>{
  if(specialVisible) return;
  clickCount++;
  ratio = clickCount/maxClicks;
  if(clickCount===maxClicks){
    showSpecialImage();
  }
});

// Show special image
function showSpecialImage(){
  specialVisible = true;
  audioElement.pause();
  document.getElementById('set9special').style.display = 'block';
}

</script>
</body>
</html>
