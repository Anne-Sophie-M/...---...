<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultra Chaotic Glitch & Audio</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background: black;
  }
  canvas {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    object-fit: cover;
    z-index:-1;
  }
  #startButton {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:transparent;
    border:none;
    cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>

<audio id="audio" loop></audio>
<canvas id="canvas"></canvas>
<button id="startButton"></button>

<script>
// ---- Images & Audio ----
const images = [
  "images/image1.jpg",
  "images/image2.jpg",
  "images/image3.jpg",
  "https://picsum.photos/1920/1080?random=1",
  "https://picsum.photos/1920/1080?random=2"
];
const audios = [
  "audio/audio1.mp3",
  "audio/audio2.mp3",
  "audio/audio3.mp3"
];

// ---- Canvas Setup ----
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext('2d');
let img = new Image();
const randomImage = images[Math.floor(Math.random()*images.length)];
img.crossOrigin = "anonymous";
img.src = randomImage;

// ---- Audio Setup ----
const audioElement = document.getElementById("audio");
const randomAudio = audios[Math.floor(Math.random()*audios.length)];
audioElement.src = randomAudio;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
const distortion = audioCtx.createWaveShaper();
const filter = audioCtx.createBiquadFilter();
const gainNode = audioCtx.createGain();

source.connect(distortion);
distortion.connect(filter);
filter.connect(gainNode);
gainNode.connect(audioCtx.destination);
gainNode.gain.value = 1;

// fonction distorsion
function makeDistortionCurve(amount) {
  const k = amount;
  const n_samples = 44100;
  const curve = new Float32Array(n_samples);
  const deg = Math.PI / 180;
  for (let i=0; i<n_samples; i++) {
    const x = i*2/n_samples-1;
    curve[i] = ((3+k)*x*20*deg)/(Math.PI+k*Math.abs(x));
  }
  return curve;
}

// ---- Start Button ----
const startButton = document.getElementById("startButton");
startButton.addEventListener("click", () => {
  audioCtx.resume();
  audioElement.play();
  startButton.style.display = "none";
});

// ---- Détérioration progressive ----
let clickCount = 0;
const maxClicks = 47;
let ratio = 0;

// dessiner image initiale
img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;
};

// clic : augmenter ratio
document.body.addEventListener("click", () => {
  if(clickCount >= maxClicks) return;
  clickCount++;
  ratio = clickCount/maxClicks;
});

// ---- Animation Loop ----
function animate() {
  requestAnimationFrame(animate);
  if(!img.complete) return;

  let w = canvas.width;
  let h = canvas.height;

  // pixelisation
  const pixelFactor = 1 - 0.8*ratio;
  const sw = Math.max(1, Math.floor(w * pixelFactor));
  const sh = Math.max(1, Math.floor(h * pixelFactor));

  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = sw;
  tempCanvas.height = sh;
  const tCtx = tempCanvas.getContext('2d');
  tCtx.drawImage(img, 0, 0, sw, sh);

  ctx.drawImage(tempCanvas, 0, 0, w, h);

  // glitch dynamique
  const blockCount = Math.floor(ratio*250);
  for(let i=0;i<blockCount;i++){
    const bx = Math.floor(Math.random()*w);
    const by = Math.floor(Math.random()*h);
    const bw = Math.floor(Math.random()*50 + 5);
    const bh = Math.floor(Math.random()*50 + 5);
    const temp = ctx.getImageData(bx, by, bw, bh);
    const dx = Math.floor((Math.random()-0.5)*250*ratio);
    const dy = Math.floor((Math.random()-0.5)*250*ratio);
    ctx.putImageData(temp, bx+dx, by+dy);
  }

  // bruit aléatoire dynamique
  const numPixels = Math.floor(15000 + ratio*150000);
  const imageData = ctx.getImageData(0,0,w,h);
  for(let i=0;i<numPixels;i++){
    const x = Math.floor(Math.random()*w);
    const y = Math.floor(Math.random()*h);
    const idx = (y*w + x)*4;
    imageData.data[idx] = Math.random()*255;
    imageData.data[idx+1] = Math.random()*255;
    imageData.data[idx+2] = Math.random()*255;
  }
  ctx.putImageData(imageData,0,0);

  // fractures dynamiques
  const fractureCount = Math.floor(ratio*50);
  for(let i=0;i<fractureCount;i++){
    const x1 = Math.floor(Math.random()*w);
    const y1 = Math.floor(Math.random()*h);
    const x2 = x1 + Math.floor(Math.random()*100*ratio*(Math.random()-0.5));
    const y2 = y1 + Math.floor(Math.random()*100*ratio*(Math.random()-0.5));
    ctx.strokeStyle = `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.5)`;
    ctx.lineWidth = 1 + ratio*3;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }

  // filtre CSS dynamique
  const contrast = 1 + ratio*5;
  const saturate = 1 + ratio*5;
  const hue = ratio*360;
  document.body.style.filter = `contrast(${contrast}) saturate(${saturate}) hue-rotate(${hue}deg)`;

  // audio dynamique
  distortion.curve = makeDistortionCurve(ratio*700);
  distortion.oversample = '4x';
  filter.type = 'allpass';
  filter.frequency.value = 500 + Math.random()*ratio*2000;
  audioElement.playbackRate = 1 + ratio * 0.8 + (Math.random()*0.03);
}

animate();
