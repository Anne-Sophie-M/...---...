<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Pièges</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; background:black; overflow:hidden; cursor:pointer; }
#background { position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; opacity:1; transition:opacity 0.5s ease-out; filter:contrast(1.2) brightness(0.9);}
#grain { position:absolute; top:0; left:0; width:100%; height:100%; background:url('https://i.imgur.com/9l9bU.jpg'); background-size:cover; mix-blend-mode:overlay; opacity:0.2; animation:grainMove 1s steps(8) infinite; pointer-events:none;}
@keyframes grainMove {0%{transform:translate(0,0);}20%{transform:translate(-4px,2px);}40%{transform:translate(3px,-2px);}60%{transform:translate(-2px,1px);}80%{transform:translate(2px,-1px);}100%{transform:translate(0,0);}}
#popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:10; display:none; cursor:pointer;}
#popupContent { background:black; border:3px solid red; padding:40px; color:red; font-size:2.5em; text-align:center; text-transform:uppercase; text-shadow:0 0 15px red,0 0 30px black;}
@keyframes glitch1 {0%{transform:translate(0,0);}20%{transform:translate(-2px,1px);}40%{transform:translate(2px,-1px);}60%{transform:translate(-1px,-2px);}80%{transform:translate(1px,2px);}100%{transform:translate(0,0);}}
@keyframes glitch2 {0%{transform:translate(0,0);}20%{transform:translate(-3px,2px);}40%{transform:translate(3px,-2px);}60%{transform:translate(-2px,-3px);}80%{transform:translate(2,3px);}100%{transform:translate(0,0);}}
@keyframes glitch3 {0%{transform:translate(0,0);}20%{transform:translate(-4px,2px);}40%{transform:translate(4px,-3px);}60%{transform:translate(-3px,-4px);}80%{transform:translate(3px,4px);}100%{transform:translate(0,0);}}
</style>
</head>
<body>
<div id="background"></div>
<div id="grain"></div>
<div id="popup"><div id="popupContent"></div></div>
<audio id="audio1" loop></audio>
<audio id="audio2" loop></audio>

<script>
const etapes = [
  { img:"https://picsum.photos/id/237/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, 
  { img:null, popup:"C'est coincé !", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
  { img:"https://picsum.photos/id/1025/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
  { img:null, popup:"C'EST BLOQUÉ !", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
  { img:"https://picsum.photos/id/1003/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" },
  { img:null, popup:"C'est trop tard....", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
  { img:"https://picsum.photos/id/1069/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
  { img:null, popup:"C'est notre petit secret", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
  { img:"https://picsum.photos/id/1021/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
];

let index = 0;
const bgEl = document.getElementById("background");
const popup = document.getElementById("popup");
const popupContent = document.getElementById("popupContent");
const glitches = ["glitch1","glitch2","glitch3"];
const audio1 = document.getElementById("audio1");
const audio2 = document.getElementById("audio2");
let currentAudio = audio1;
let nextAudio = audio2;
let firstClickDone = false;

bgEl.style.backgroundImage = `url(${etapes[0].img})`;

// ---------- Audio ----------
function playAudio(src){
  nextAudio.src = src;
  nextAudio.volume = 0;
  nextAudio.play().catch(()=>{});
  let vol=0;
  const fade=setInterval(()=>{
    vol+=0.02;
    if(vol>=1){vol=1; clearInterval(fade);}
    nextAudio.volume=vol;
    currentAudio.volume=1-vol;
  },50);
  [currentAudio,nextAudio]=[nextAudio,currentAudio];
}

// ---------- Images ----------
function fadeOut(callback){
  bgEl.style.transition="opacity 0.3s ease-out";
  bgEl.style.opacity=0;
  setTimeout(callback,300);
}
function fadeIn(src){
  bgEl.style.backgroundImage=`url(${src})`;
  bgEl.style.transition="opacity 1s ease-in";
  bgEl.style.opacity=1;
}

// ---------- Popup ----------
function showPopup(text, level){
  fadeOut(()=>{
    popupContent.textContent=text;
    popup.style.display="flex";
    let gIndex=Math.min(level, glitches.length-1);
    popupContent.style.animation=`${glitches[gIndex]} 0.15s infinite`;
  });
}

// ---------- Étape suivante ----------
function nextStep(){
  index++;
  if(index>=etapes.length) return;
  const step = etapes[index];
  if(step.audio) playAudio(step.audio);
  if(step.img) fadeIn(step.img);
  if(index===etapes.length-1){
    window.onpopstate=null; // dernier retour normal
  } else {
    history.pushState({step:index},"");
  }
}

// ---------- Premier clic image ----------
bgEl.addEventListener("click",()=>{
  if(!firstClickDone){
    firstClickDone=true;
    playAudio(etapes[0].audio);
  }
});

// ---------- Clic popup ----------
popup.addEventListener("click",()=>{
  popup.style.display="none";
  nextStep();
});

// ---------- Retour navigateur ----------
history.pushState({step:0},"");
window.onpopstate=function(){
  const step = etapes[index];
  if(index<etapes.length-1){ // toujours intercepter
    showPopup(step.popup || "C'est coincé !", index);
  } else {
    window.onpopstate=null;
    history.back(); // dernier retour normal
  }
};
</script>
</body>
</html>
