<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image & Audio Corruption Extreme</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background: black;
    transition: filter 0.3s ease;
  }
  canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }
  #startButton {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:transparent;
    border:none;
    cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>

<audio id="audio" loop></audio>
<canvas id="canvas"></canvas>
<button id="startButton"></button>

<script>
// ---- Images & Audio ----
const images = [
  "images/image1.jpg",
  
  "https://picsum.photos/1920/1080?random=1",
  "https://picsum.photos/1920/1080?random=2"
];
const audios = [
  "audio/audio1.mp3",
  
];

// ---- Canvas Setup ----
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext('2d');
let img = new Image();
const randomImage = images[Math.floor(Math.random()*images.length)];
img.crossOrigin = "anonymous";
img.src = randomImage;

img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

// ---- Audio Setup Web Audio API ----
const audioElement = document.getElementById("audio");
const randomAudio = audios[Math.floor(Math.random()*audios.length)];
audioElement.src = randomAudio;

// Audio Context pour distorsion
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
const distortion = audioCtx.createWaveShaper();
const filter = audioCtx.createBiquadFilter();
const gainNode = audioCtx.createGain();

source.connect(distortion);
distortion.connect(filter);
filter.connect(gainNode);
gainNode.connect(audioCtx.destination);

// Volume constant
gainNode.gain.value = 1;

// Simple fonction pour distorsion
function makeDistortionCurve(amount) {
  const k = amount;
  const n_samples = 44100;
  const curve = new Float32Array(n_samples);
  const deg = Math.PI / 180;
  for (let i=0; i<n_samples; i++) {
    const x = i*2/n_samples-1;
    curve[i] = ((3+k)*x*20*deg)/(Math.PI+k*Math.abs(x));
  }
  return curve;
}

// ---- Start Button ----
const startButton = document.getElementById("startButton");
startButton.addEventListener("click", () => {
  audioCtx.resume();
  audioElement.play();
  startButton.style.display = "none";
});

// ---- Détérioration progressive ----
let clickCount = 0;
const maxClicks = 25;

document.body.addEventListener("click", () => {
  if(clickCount >= maxClicks) return;
  clickCount++;

  const ratio = clickCount / maxClicks; // 0 → 1

  // --- Image : glitch progressif ---
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  // Ajouter du bruit + pixels décalés
  const numPixels = Math.floor(5000 + ratio*50000); 
  for (let i=0; i<numPixels; i++) {
    const x = Math.floor(Math.random()*canvas.width);
    const y = Math.floor(Math.random()*canvas.height);
    const idx = (y*canvas.width+x)*4;
    imageData.data[idx] = Math.random()*255;
    imageData.data[idx+1] = Math.random()*255;
    imageData.data[idx+2] = Math.random()*255;
  }

  // Décalage de blocs aléatoires
  const blockCount = Math.floor(ratio*100);
  for (let i=0; i<blockCount; i++) {
    const bx = Math.floor(Math.random()*canvas.width);
    const by = Math.floor(Math.random()*canvas.height);
    const bw = Math.floor(Math.random()*20 + 5);
    const bh = Math.floor(Math.random()*20 + 5);
    const temp = ctx.getImageData(bx, by, bw, bh);
    const dx = Math.floor((Math.random()-0.5)*50*ratio);
    const dy = Math.floor((Math.random()-0.5)*50*ratio);
    ctx.putImageData(temp, bx+dx, by+dy);
  }

  ctx.putImageData(imageData, 0, 0);

  // CSS glitch supplémentaire
  const blur = ratio*15;
  const gray = ratio;
  const contrast = Math.max(1 - ratio*0.8,0.2);
  const brightness = Math.max(1 - ratio*0.7,0.1);
  document.body.style.filter = `blur(${blur}px) grayscale(${gray}) contrast(${contrast}) brightness(${brightness})`;

  // --- Audio : distorsion progressive ---
  distortion.curve = makeDistortionCurve(ratio*500);
  distortion.oversample = '4x';
  filter.type = 'allpass';
  filter.frequency.value = 500 + Math.random()*ratio*1000; 
  audioElement.playbackRate = 1 - ratio*0.15 + (Math.random()*0.05); // pitch instable
});
</script>

</body>
</html>
