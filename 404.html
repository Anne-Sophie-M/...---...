<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Piège</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: black;
      overflow: hidden;
    }

    /* Image plein écran */
    #background {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      transition: background-image 0.8s ease-in-out;
      filter: contrast(1.2) brightness(0.9);
    }

    /* Effet vieux projecteur : grain */
    #grain {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: url('https://i.imgur.com/9l9bU.jpg');
      background-size: cover;
      mix-blend-mode: overlay;
      opacity: 0.2;
      animation: grainMove 1s steps(8) infinite;
      pointer-events: none;
    }
    @keyframes grainMove {
      0% { transform: translate(0,0); }
      20% { transform: translate(-4px,2px); }
      40% { transform: translate(3px,-2px); }
      60% { transform: translate(-2px,1px); }
      80% { transform: translate(2px,-1px); }
      100% { transform: translate(0,0); }
    }

    /* Popup personnalisé */
    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      display: none;
    }
    #popupContent {
      background: black;
      border: 3px solid red;
      padding: 40px;
      color: red;
      font-size: 2.5em;
      text-align: center;
      text-transform: uppercase;
      text-shadow: 0 0 15px red, 0 0 30px black;
    }

    /* Glitch shakes (faible rayon mais rapide) */
    @keyframes glitch1 {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-2px, 1px); }
      40% { transform: translate(2px, -1px); }
      60% { transform: translate(-1px, -2px); }
      80% { transform: translate(1px, 2px); }
      100% { transform: translate(0, 0); }
    }
    @keyframes glitch2 {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-3px, 2px); }
      40% { transform: translate(3px, -2px); }
      60% { transform: translate(-2px, -3px); }
      80% { transform: translate(2px, 3px); }
      100% { transform: translate(0, 0); }
    }
    @keyframes glitch3 {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-4px, 2px); }
      40% { transform: translate(4px, -3px); }
      60% { transform: translate(-3px, -4px); }
      80% { transform: translate(3px, 4px); }
      100% { transform: translate(0, 0); }
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <div id="grain"></div>

  <div id="popup">
    <div id="popupContent"></div>
  </div>
  
  <audio id="audio" autoplay loop></audio>

  <script>
    const etapes = [
      { 
        img: "https://picsum.photos/id/237/1920/1080", 
        audio: "https://upload.wikimedia.org/wikipedia/commons/0/05/Deep_breath.ogg", 
        popup: "C'est coincé !" 
      },
      { 
        img: "https://picsum.photos/id/1025/1920/1080", 
        audio: "https://upload.wikimedia.org/wikipedia/commons/8/89/Breathing.ogg", 
        popup: "C'EST BLOQUÉ !" 
      },
      { 
        img: "https://picsum.photos/id/1003/1920/1080", 
        audio: "https://upload.wikimedia.org/wikipedia/commons/3/3f/Breathing_fast.ogg", 
        popup: "C'est trop tard...." 
      },
      { 
        img: "https://picsum.photos/id/1069/1920/1080", 
        audio: "https://upload.wikimedia.org/wikipedia/commons/b/bb/Footsteps.ogg", 
        popup: "C'est notre petit secret" 
      },
      { 
        img: "https://picsum.photos/id/1021/1920/1080", 
        audio: "https://upload.wikimedia.org/wikipedia/commons/c/cf/Violin.ogg", 
        popup: null 
      }
    ];

    let index = 0;
    const bgEl = document.getElementById("background");
    const audioEl = document.getElementById("audio");
    const popup = document.getElementById("popup");
    const popupContent = document.getElementById("popupContent");

    const glitches = ["glitch1", "glitch2", "glitch3"];

    // première étape (affiche l'image et son)
    function setEtape(i) {
      bgEl.style.backgroundImage = `url(${etapes[i].img})`;
      audioEl.src = etapes[i].audio;
      audioEl.play();
    }
    setEtape(0);

    function changerEtape() {
      index++;
      if (index < etapes.length) {
        // afficher d'abord le popup
        if (etapes[index].popup) {
          popupContent.textContent = etapes[index].popup;
          popup.style.display = "flex";

          // applique un glitch qui augmente
          let gIndex = Math.min(index - 1, glitches.length - 1);
          popupContent.style.animation = `${glitches[gIndex]} 0.15s infinite`;
        } else {
          // dernière étape sans popup → affiche directement l'image
          setEtape(index);
        }

        // Tant qu’on n’est pas à la dernière étape, on piège encore
        if (index < etapes.length - 1) {
          history.pushState({step:index}, "");
        }
      }
    }

    // Fermer le popup => seulement à ce moment on change l'image et l'audio
    popup.addEventListener("click", () => {
      popup.style.display = "none";
      setEtape(index);
    });

    // Interception du bouton retour
    history.pushState({step:0}, "");
    window.onpopstate = function(e) {
      changerEtape();
    };
  </script>
</body>
</html>
