<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Piège</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; background:black; overflow:hidden; cursor:pointer;}
#background { position:absolute; top:0; left:0; width:100%; height:100%; background-size:cover; background-position:center; opacity:1; transition:opacity 0.3s ease-out; filter:contrast(1.2) brightness(0.9);}
#grain {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background: repeating-linear-gradient(0deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, transparent 1px, transparent 2px);
  mix-blend-mode:overlay; opacity:0.25; animation:grainMove 0.8s steps(8) infinite; pointer-events:none;
}
@keyframes grainMove {0%{transform:translate(0,0);}20%{transform:translate(-5px,3px);}40%{transform:translate(4px,-3px);}60%{transform:translate(-3px,2px);}80%{transform:translate(3px,-2px);}100%{transform:translate(0,0);}}
#dust {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
  background-size:10px 10px; mix-blend-mode:screen; opacity:0.15; animation:dustMove 5s linear infinite; pointer-events:none;
}
@keyframes dustMove {0%{transform:translate(0,0);}100%{transform:translate(-200px,200px);}}
#popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:10; display:none; cursor:pointer;}
#popupContent { background:black; border:3px solid red; padding:40px; color:red; font-size:2.5em; text-align:center; text-transform:uppercase; text-shadow:0 0 15px red,0 0 30px black;}
@keyframes glitch1 {0%{transform:translate(0,0);}20%{transform:translate(-1px,0);}40%{transform:translate(1px,0);}60%{transform:translate(-1px,0);}80%{transform:translate(1px,0);}100%{transform:translate(0,0);}}
@keyframes glitch2 {0%{transform:translate(0,0);}20%{transform:translate(-2px,1px);}40%{transform:translate(2px,-1px);}60%{transform:translate(-2px,1px);}80%{transform:translate(2px,-1px);}100%{transform:translate(0,0);}}
@keyframes glitch3 {0%{transform:translate(0,0);}20%{transform:translate(-4px,2px);}40%{transform:translate(4px,-2px);}60%{transform:translate(-4px,2px);}80%{transform:translate(4px,-2px);}100%{transform:translate(0,0);}}
</style>
</head>
<body>

<div id="background"></div>
<div id="grain"></div>
<div id="dust"></div>
<div id="popup"><div id="popupContent"></div></div>

<audio id="audio1" loop></audio>
<audio id="audio2" loop></audio>

<script>
// ----- Scénario exact -----
const etapes = [
  { img:"https://picsum.photos/id/1011/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, // 1ère image
  { img:null, popup:"Je ne peux pas.. c'est bloqué !", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" }, // popup 1
  { img:"https://picsum.photos/id/1012/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }, // 2ème image
  { img:null, popup:"J'essaye !", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" }, // popup 2
  { img:"https://picsum.photos/id/1015/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }, // 3ème image
  { img:null, popup:"Je n'y arrive pas !!!", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" }, // popup 3
  { img:"https://picsum.photos/id/1016/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" }, // 4ème image
  { img:null, popup:"C'est trop tard...", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" }, // popup 4
  { img:"https://picsum.photos/id/1018/1920/1080", popup:null, audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, // dernière image
  { img:null, popup:"...---...", audio:"https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" } // dernier popup
];

let index = 0;
const bgEl = document.getElementById("background");
const popup = document.getElementById("popup");
const popupContent = document.getElementById("popupContent");
const audio1 = document.getElementById("audio1");
const audio2 = document.getElementById("audio2");
let currentAudio = audio1;
let nextAudio = audio2;
let firstClickDone = false;

bgEl.style.backgroundImage = `url(${etapes[0].img})`;

// ----- Audio crossfade -----
function playAudio(src){
  nextAudio.src = src;
  nextAudio.volume = 0;
  nextAudio.play().catch(()=>{});
  let vol = 0;
  const fade = setInterval(()=>{
    vol += 0.02;
    if(vol>=1){vol=1; clearInterval(fade);}
    nextAudio.volume = vol;
    currentAudio.volume = 1-vol;
  },50);
  [currentAudio, nextAudio] = [nextAudio, currentAudio];
}

// ----- Image fade -----
function fadeOut(callback){
  bgEl.style.transition = "opacity 0.3s ease-out";
  bgEl.style.opacity=0;
  setTimeout(callback,300);
}
function fadeIn(src){
  bgEl.style.backgroundImage = `url(${src})`;
  bgEl.style.transition = "opacity 1s ease-in";
  bgEl.style.opacity=1;
}

// ----- Popup glitch + grain/poussière -----
function showPopup(stepIndex){
  const step = etapes[stepIndex];
  fadeOut(()=>{
    if(step.audio) playAudio(step.audio);
    popupContent.textContent = step.popup;
    popup.style.display = "flex";
    let glitchLevel = Math.min(Math.floor(stepIndex/2)+1, 3); 
    popupContent.style.animation = `glitch${glitchLevel} 0.15s infinite`;
    // grain + poussière progressif
    const grain = document.getElementById("grain");
    const dust = document.getElementById("dust");
    grain.style.opacity = Math.min(0.25 + 0.05*stepIndex, 0.7);
    dust.style.opacity = Math.min(0.15 + 0.05*stepIndex, 0.5);
    grain.style.animationDuration = Math.max(0.8 - 0.05*stepIndex,0.2)+"s";
    dust.style.animationDuration = Math.max(5 - 0.2*stepIndex,0.5)+"s";
  });
}

// ----- Étape suivante -----
function nextStep(){
  index++;
  if(index>=etapes.length) return;
  const step = etapes[index];
  if(step.img) fadeIn(step.img);
  if(index===etapes.length-1){
    window.onpopstate = null;
  } else {
    history.pushState({step:index},"");
  }
}

// ----- Premier clic image -----
bgEl.addEventListener("click", ()=>{
  if(!firstClickDone){
    firstClickDone=true;
    playAudio(etapes[0].audio);
  }
});

// ----- Clic popup -----
popup.addEventListener("click", ()=>{
  popup.style.display="none";
  nextStep();
});

// ----- Retour navigateur -----
history.pushState({step:0},"");
window.onpopstate = function(){
  if(index >= etapes.length-1){
    window.onpopstate = null;
    history.back();
    return;
  }
  showPopup(index);
};
</script>
</body>
</html>
