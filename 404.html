<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Glitch Finale 9 Sets</title>
<style>
html,body {margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:black;}
canvas {position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;}
#startButton {position:fixed; top:0; left:0; width:100%; height:100%; background:transparent; border:none; cursor:pointer; z-index:10;}
#finalText {
  position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:3vw; color:white; font-family:sans-serif;
  text-align:center; pointer-events:none; display:none;
  max-width: 80vw;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div id="finalText"></div>
<audio id="audio" loop></audio>
<button id="startButton"></button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- 9 sets ---
const sets = [
  { images:["images/set1trans1.jpg","images/set1trans2.jpg","images/set1trans3.jpg","images/set1trans4.jpg","images/set1final.jpg"], audio:"audio/audio1.mp3", text:"Bravo, tu as brisé son innocence" },
  { images:["images/set2trans1.jpg","images/set2trans2.jpg","images/set2trans3.jpg","images/set2trans4.jpg","images/set2final.jpg"], audio:"audio/audio2.mp3", text:"Et la Mère, fermant le livre du devoir, S'en allait satisfaite et très fière, sans voir, Dans les yeux bleus et sous le front plein d'éminences, L'âme de son enfant livrée aux répugnances." },
  { images:["images/set3trans1.jpg","images/set3trans2.jpg","images/set3trans3.jpg","images/set3trans4.jpg","images/set3final.jpg"], audio:"audio/audio3.mp3", text:"Elles avaient confiance en toi" },
  { images:["images/set4trans1.jpg","images/set4trans2.jpg","images/set4trans3.jpg","images/set4trans4.jpg","images/set4final.jpg"], audio:"audio/audio4.mp3", text:"Le silence a tout vu, tu ne peux plus rien cacher" },
  { images:["images/set5trans1.jpg","images/set5trans2.jpg","images/set5trans3.jpg","images/set5trans4.jpg","images/set5final.jpg"], audio:"audio/audio5.mp3", text:"Les ombres te jugent, mais personne ne te sauvera" },
  { images:["images/set6trans1.jpg","images/set6trans2.jpg","images/set6trans3.jpg","images/set6trans4.jpg","images/set6final.jpg"], audio:"audio/audio6.mp3", text:"Tout s'effondre, et tu es seul face à la vérité" },
  { images:["images/set7trans1.jpg","images/set7trans2.jpg","images/set7trans3.jpg","images/set7trans4.jpg","images/set7final.jpg"], audio:"audio/audio7.mp3", text:"La fin approche, et le monde est devenu froid" },
  { images:["images/set8trans1.jpg","images/set8trans2.jpg","images/set8trans3.jpg","images/set8trans4.jpg","images/set8final.jpg"], audio:"audio/audio8.mp3", text:"Rien ne pourra réparer ce qui a été fait" },
  { images:["images/set9trans1.jpg","images/set9trans2.jpg","images/set9trans3.jpg","images/set9trans4.jpg","images/set9final.jpg"], audio:"audio/audio9.mp3", text:"Le dernier souffle de l'innocence s'éteint ici" }
];

// Choix aléatoire du set
const chosenSet = sets[Math.floor(Math.random()*sets.length)];
const transitions = chosenSet.images;
const audioSrc = chosenSet.audio;
const finalText = chosenSet.text;

const steps = [10,20,30,40,47];

// Préchargement images
let loadedImages = [];
async function preloadImages(sources){
  const promises = sources.map(src => new Promise(resolve => {
    const img = new Image();
    img.src = src;
    img.onload = ()=>resolve(img);
    img.onerror = ()=>resolve(img);
  }));
  loadedImages = await Promise.all(promises);
}

// Canvas temporaires pour morphing
const temp1 = document.createElement('canvas');
const temp2 = document.createElement('canvas');
const tctx1 = temp1.getContext('2d');
const tctx2 = temp2.getContext('2d');
temp1.width = canvas.width; temp1.height = canvas.height;
temp2.width = canvas.width; temp2.height = canvas.height;

// Audio
const audioElement = document.getElementById('audio');
audioElement.src = audioSrc;
const finalAudioSrc = "audio/final_scream.mp3";
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
const distortion = audioCtx.createWaveShaper();
const filter = audioCtx.createBiquadFilter();
const gainNode = audioCtx.createGain();
source.connect(distortion);
distortion.connect(filter);
filter.connect(gainNode);
gainNode.connect(audioCtx.destination);
gainNode.gain.value = 1;

// Start button
document.getElementById('startButton').addEventListener('click',()=>{
  audioCtx.resume();
  audioElement.play();
  document.getElementById('startButton').style.display='none';
});

// Clicks
let clickCount = 0, maxClicks = 47, ratio = 0, finalMode = false;
document.body.addEventListener('click', ()=>{
  if(finalMode) return;
  if(clickCount < maxClicks) clickCount++;
  ratio = clickCount / maxClicks;
});

// Crash final déclenché manuellement
function activateFinalMode(){
  finalMode = true;
  audioElement.pause();
  audioElement.src = finalAudioSrc;
  audioElement.loop = true;
  audioElement.play();
  const ft = document.getElementById('finalText');
  ft.innerText = finalText;
  ft.style.display = 'block';
  document.body.style.filter = 'none';
}

// Distorsion audio
function makeDistortionCurve(amount){
  const curve = new Float32Array(44100);
  const deg = Math.PI/180;
  for(let i=0;i<44100;i++){
    const x = i*2/44100-1;
    curve[i] = ((3+amount)*x*20*deg)/(Math.PI+amount*Math.abs(x));
  }
  return curve;
}

// Indices et alpha morphing
function getTransitionIndex(clickCount){
  for(let i=0;i<steps.length;i++){
    if(clickCount <= steps[i]){
      const prevIndex = i === 0 ? 0 : i-1;
      const alpha = (clickCount - (i===0?0:steps[i-1])) / (steps[i] - (i===0?0:steps[i-1]));
      return {prevIndex, nextIndex:i, alpha};
    }
  }
  return {prevIndex: transitions.length-2, nextIndex: transitions.length-1, alpha:1};
}

// Morphing optimisé
function morphImages(ctx, img1, img2, alpha){
  tctx1.clearRect(0,0,temp1.width,temp1.height);
  tctx2.clearRect(0,0,temp2.width,temp2.height);
  tctx1.drawImage(img1,0,0,temp1.width,temp1.height);
  tctx2.drawImage(img2,0,0,temp2.width,temp2.height);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.globalAlpha = 1-alpha;
  ctx.drawImage(temp1,0,0,canvas.width,canvas.height);
  ctx.globalAlpha = alpha;
  ctx.drawImage(temp2,0,0,canvas.width,canvas.height);
  ctx.globalAlpha = 1;
}

// Animation
async function draw(){
  await preloadImages(transitions);
  function frame(){
    requestAnimationFrame(frame);

    // Crash déclenché après le dernier clic
    if(clickCount > maxClicks){
      if(!finalMode) activateFinalMode();

      // Fond rouge uniforme
      ctx.fillStyle = "rgb(255,0,0)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Blocs glitchés tremblants
      const blockCount = 500;
      for(let i=0;i<blockCount;i++){
        const x=Math.floor(Math.random()*canvas.width);
        const y=Math.floor(Math.random()*canvas.height);
        const bw=Math.floor(Math.random()*50+10);
        const bh=Math.floor(Math.random()*50+10);
        const offsetX = Math.floor((Math.random()-0.5)*20);
        const offsetY = Math.floor((Math.random()-0.5)*20);
        ctx.fillStyle = `rgba(255,0,0,${Math.random()*0.6+0.2})`;
        ctx.fillRect(x+offsetX,y+offsetY,bw,bh);
      }
      return;
    }

    // Morphing images
    const {prevIndex, nextIndex, alpha} = getTransitionIndex(clickCount);
    morphImages(ctx, loadedImages[prevIndex], loadedImages[nextIndex], alpha);

    // Fractures vibrantes jusqu’au dernier clic
    const fracCount = Math.floor(ratio*50);
    const time = Date.now()*0.002;
    for(let i=0;i<fracCount;i++){
      const x1 = Math.floor(Math.random()*canvas.width);
      const y1 = Math.floor(Math.random()*canvas.height);
      const offsetX = Math.sin(time+i)*50*ratio;
      const offsetY = Math.cos(time+i)*50*ratio;
      const x2 = x1 + Math.floor(offsetX);
      const y2 = y1 + Math.floor(offsetY);
      ctx.strokeStyle = `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.5)`;
      ctx.lineWidth = 1 + ratio*2;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
    }

    // Couleurs progressives vers rouge
    const targetContrast = 6;
    const targetSaturate = 6;
    const contrast = 1 + ratio*(targetContrast-1);
    const saturate = 1 + ratio*(targetSaturate-1);
    const hue = 0; // rouge
    document.body.style.filter = `contrast(${contrast}) saturate(${saturate}) hue-rotate(${hue}deg)`;

    // Audio distortion progressive
    distortion.curve = makeDistortionCurve(ratio*700);
    distortion.oversample='4x';
    filter.type='allpass';
    filter.frequency.value = 500 + Math.random()*ratio*2000;
    audioElement.playbackRate = 1 + ratio*0.8;
  }
  frame();
}

draw();
</script>

</body>
</html>
