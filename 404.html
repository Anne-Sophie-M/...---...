<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Audio-Reactive Glitch Fullscreen</title>
<style>
html,body {margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:black;}
canvas {position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1;}
#startButton {position:fixed; top:0; left:0; width:100%; height:100%; background:transparent; border:none; cursor:pointer; z-index:10;}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<audio id="audio" loop></audio>
<button id="startButton"></button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Images & audio
const images = ["https://picsum.photos/1920/1080?random=1"];
const audios = ["audio/audio1.mp3"]; // ajoute tes fichiers

// Image setup
let img = new Image();
img.crossOrigin = 'anonymous';
img.src = images[Math.floor(Math.random()*images.length)];

// Temp canvas pour pixelisation
const temp = document.createElement('canvas');
const tctx = temp.getContext('2d');

// Audio setup
const audioElement = document.getElementById('audio');
audioElement.src = audios[Math.floor(Math.random()*audios.length)];
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
const distortion = audioCtx.createWaveShaper();
const filter = audioCtx.createBiquadFilter();
const gainNode = audioCtx.createGain();
const analyser = audioCtx.createAnalyser();
source.connect(distortion);
distortion.connect(filter);
filter.connect(gainNode);
gainNode.connect(analyser);
analyser.connect(audioCtx.destination);
gainNode.gain.value = 1;
analyser.fftSize = 256;
const dataArray = new Uint8Array(analyser.frequencyBinCount);

function makeDistortionCurve(amount){
  const k = amount;
  const n = 44100;
  const curve = new Float32Array(n);
  const deg = Math.PI/180;
  for(let i=0;i<n;i++){
    const x = i*2/n-1;
    curve[i] = ((3+k)*x*20*deg)/(Math.PI+k*Math.abs(x));
  }
  return curve;
}

// Start button
document.getElementById('startButton').addEventListener('click',()=>{
  audioCtx.resume();
  audioElement.play();
  document.getElementById('startButton').style.display='none';
});

// Clicks & ratio
let clickCount = 0, maxClicks = 47, ratio = 0;
document.body.addEventListener('click',()=>{if(clickCount<maxClicks) clickCount++; ratio = clickCount/maxClicks;});

// Animation
img.onload = ()=>{
  temp.width = img.width;
  temp.height = img.height;
  requestAnimationFrame(draw);
}

function draw(){
  requestAnimationFrame(draw);
  if(!img.complete) return;

  analyser.getByteFrequencyData(dataArray);
  const volume = dataArray.reduce((a,b)=>a+b,0)/dataArray.length/255; // 0->1

  const w = canvas.width;
  const h = canvas.height;

  // Pixelisation rapide et full screen
  const scale = 1 - 0.8*ratio;
  const sw = Math.max(1, Math.floor(img.width*scale));
  const sh = Math.max(1, Math.floor(img.height*scale));
  tctx.clearRect(0,0,temp.width,temp.height);
  tctx.drawImage(img,0,0,img.width,img.height,0,0,sw,sh);
  ctx.clearRect(0,0,w,h);
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(temp,0,0,sw,sh,0,0,w,h);

  // Glitch
  const blockCount = Math.floor(ratio*200);
  for(let i=0;i<blockCount;i++){
    const bx = Math.floor(Math.random()*w);
    const by = Math.floor(Math.random()*h);
    const bw = Math.floor(Math.random()*30 + 5);
    const bh = Math.floor(Math.random()*30 + 5);
    const tempData = ctx.getImageData(bx,by,bw,bh);
    const dx = Math.floor((Math.random()-0.5)*150*ratio*volume);
    const dy = Math.floor((Math.random()-0.5)*150*ratio*volume);
    ctx.putImageData(tempData,bx+dx,by+dy);
  }

  // Fractures audio-rÃ©actives
  const fracCount = Math.floor(ratio*50);
  const time = Date.now()*0.002;
  for(let i=0;i<fracCount;i++){
    const x1 = Math.floor(Math.random()*w);
    const y1 = Math.floor(Math.random()*h);
    const offsetX = Math.sin(time+i)*50*ratio*volume*2;
    const offsetY = Math.cos(time+i)*50*ratio*volume*2;
    const x2 = x1 + Math.floor(offsetX);
    const y2 = y1 + Math.floor(offsetY);
    ctx.strokeStyle = `rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.5)`;
    ctx.lineWidth = 1 + ratio*2;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }

  // CSS filtre
  const contrast = 1 + ratio*5;
  const saturate = 1 + ratio*5;
  const hue = ratio*360;
  document.body.style.filter = `contrast(${contrast}) saturate(${saturate}) hue-rotate(${hue}deg)`;

  // Audio
  distortion.curve = makeDistortionCurve(ratio*700);
  distortion.oversample='4x';
  filter.type='allpass';
  filter.frequency.value = 500 + Math.random()*ratio*2000;
  audioElement.playbackRate = 1 + ratio*0.8 + Math.random()*0.02;
}
</script>

</body>
</html>
