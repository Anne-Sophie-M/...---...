<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Random Image & Audio Corruption</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background: black;
    transition: filter 0.3s ease;
  }
  canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }
  #startButton {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:transparent;
    border:none;
    cursor:pointer;
    z-index:10;
  }
</style>
</head>
<body>

<audio id="audio" loop></audio>
<canvas id="canvas"></canvas>
<button id="startButton"></button>

<script>
// ---- Images & Audio ----
const images = [
  "images/image1.jpg",
  "https://picsum.photos/1920/1080?random=1",
  "https://picsum.photos/1920/1080?random=2"
];
const audios = [
  "audio/audio1.mp3",
 
];

// ---- Canvas Setup ----
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext('2d');
let img = new Image();
const randomImage = images[Math.floor(Math.random()*images.length)];
img.crossOrigin = "anonymous";
img.src = randomImage;

img.onload = () => {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

// ---- Audio Setup Web Audio API ----
const audioElement = document.getElementById("audio");
const randomAudio = audios[Math.floor(Math.random()*audios.length)];
audioElement.src = randomAudio;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const source = audioCtx.createMediaElementSource(audioElement);
const gainNode = audioCtx.createGain();
const distortion = audioCtx.createWaveShaper();
const filter = audioCtx.createBiquadFilter();

source.connect(distortion);
distortion.connect(filter);
filter.connect(gainNode);
gainNode.connect(audioCtx.destination);

function makeDistortionCurve(amount) {
  const k = amount;
  const n_samples = 44100;
  const curve = new Float32Array(n_samples);
  const deg = Math.PI / 180;
  for (let i=0; i<n_samples; i++) {
    const x = i*2/n_samples-1;
    curve[i] = ((3+k)*x*20*deg)/(Math.PI+k*Math.abs(x));
  }
  return curve;
}

// ---- Start Button ----
const startButton = document.getElementById("startButton");
startButton.addEventListener("click", () => {
  audioCtx.resume();
  audioElement.play();
  startButton.style.display = "none";
});

// ---- Corruption Logic ----
let deterioration = 0;
document.body.addEventListener("click", () => {
  deterioration += 0.1;

  // --- Image corruption ---
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  for (let i=0; i<5000 + deterioration*5000; i++) {
    const x = Math.floor(Math.random()*canvas.width);
    const y = Math.floor(Math.random()*canvas.height);
    const idx = (y*canvas.width+x)*4;
    // Bruit aléatoire
    imageData.data[idx] = Math.random()*255;
    imageData.data[idx+1] = Math.random()*255;
    imageData.data[idx+2] = Math.random()*255;
  }
  ctx.putImageData(imageData,0,0);

  // Filtre CSS extrême pour glitch
  const blur = deterioration*10;
  const gray = Math.min(deterioration,1);
  const contrast = Math.max(1 - deterioration*0.5,0.2);
  const brightness = Math.max(1 - deterioration*0.4,0.2);
  document.body.style.filter = `blur(${blur}px) grayscale(${gray}) contrast(${contrast}) brightness(${brightness})`;

  // --- Audio corruption ---
  distortion.curve = makeDistortionCurve(deterioration*400); // distorsion forte
  distortion.oversample = '4x';

  filter.type = 'allpass';
  filter.frequency.value = 500 + Math.random()*deterioration*500; // fréquence instable

  audioElement.playbackRate = 1 - deterioration*0.1 + (Math.random()*0.05); // pitch instable
  gainNode.gain.value = Math.max(0.1, 1 - deterioration*0.6); // baisse de volume progressive
});
</script>

</body>
</html>
